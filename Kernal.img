sudo bash setup_zram_swap.sh
#!/bin/bash
# ------------------------------------------------------------
# Safe ZRAM + SWAP configuration for Ubuntu 22.04 LTS (Server)
# Author: Manan's optimized setup (GPT-5)
# ------------------------------------------------------------

set -e

echo "üßπ Cleaning old configurations..."
swapoff -a || true
systemctl stop zramswap.service 2>/dev/null || true

# Comment out any existing swap entry in fstab to avoid duplicates
sed -i 's|^/swapfile none swap sw 0 0|# /swapfile none swap sw 0 0|' /etc/fstab

# ------------------------------------------------------------
# üß± Step 1: Create 16 GB Disk Swap
# ------------------------------------------------------------
echo "ü™∂ Creating 16GB swapfile..."
if [ ! -f /swapfile ]; then
  fallocate -l 16G /swapfile
  chmod 600 /swapfile
  mkswap /swapfile
fi
swapon /swapfile
grep -q '/swapfile' /etc/fstab || echo '/swapfile none swap sw 0 0' >> /etc/fstab

# ------------------------------------------------------------
# üß© Step 2: Install and Configure ZRAM (Safe Dynamic Size)
# ------------------------------------------------------------
echo "‚öôÔ∏è  Installing zram-tools..."
apt update -y
apt install -y zram-tools

echo "üß© Configuring safe adaptive ZRAM..."
cat <<EOF > /etc/default/zramswap
# ZRAM configuration (auto-safe)
ENABLED=true
ALGO=zstd
# Use 200% of system RAM as compressed ZRAM (auto scales)
PERCENTAGE=200
# Number of ZRAM devices (1 is usually best)
NUM_DEVICES=1
EOF

systemctl enable zramswap.service
systemctl restart zramswap.service

# ------------------------------------------------------------
# ‚öôÔ∏è Step 3: Kernel Parameter Tuning
# ------------------------------------------------------------
echo "‚öôÔ∏è  Applying performance tuning..."
grep -q 'vm.swappiness' /etc/sysctl.conf || echo 'vm.swappiness=10' >> /etc/sysctl.conf
grep -q 'vm.vfs_cache_pressure' /etc/sysctl.conf || echo 'vm.vfs_cache_pressure=50' >> /etc/sysctl.conf
sysctl -p

# ------------------------------------------------------------
# ‚úÖ Step 4: Verify Everything
# ------------------------------------------------------------
echo "‚úÖ Setup complete. Current memory status:"
free -h
echo
echo "Swap devices:"
cat /proc/swaps
echo
echo "ZRAM block info:"
lsblk | grep zram
echo
echo "You can safely reboot now: sudo reboot"
